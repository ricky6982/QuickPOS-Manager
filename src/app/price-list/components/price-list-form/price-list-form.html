<div class="form-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>{{ titleText }}</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      @if (loading()) {
        <div class="loading-container">
          <mat-spinner></mat-spinner>
        </div>
      } @else {
        <form [formGroup]="form" (ngSubmit)="submit()">

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nombre</mat-label>
            <input matInput formControlName="name" placeholder="Ingrese el nombre de la lista de precios" />
            @if (form.get('name')?.invalid && form.get('name')?.touched) {
              <mat-error>
                @if (form.get('name')?.errors?.['required']) {
                  El nombre es requerido
                }
                @if (form.get('name')?.errors?.['minlength']) {
                  El nombre debe tener al menos 2 caracteres
                }
                @if (form.get('name')?.errors?.['maxlength']) {
                  El nombre no puede exceder 100 caracteres
                }
              </mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descripción</mat-label>
            <textarea matInput formControlName="description" placeholder="Ingrese una descripción (opcional)" rows="3"></textarea>
          </mat-form-field>

          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Alcance</mat-label>
              <mat-select formControlName="scope">
                @for (option of scopeOptions; track option.value) {
                  <mat-option [value]="option.value">{{ option.label }}</mat-option>
                }
              </mat-select>
              @if (form.get('scope')?.invalid && form.get('scope')?.touched) {
                <mat-error>
                  El alcance es requerido
                </mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Estado</mat-label>
              <mat-select formControlName="status">
                @for (option of statusOptions; track option.value) {
                  <mat-option [value]="option.value">{{ option.label }}</mat-option>
                }
              </mat-select>
              @if (form.get('status')?.invalid && form.get('status')?.touched) {
                <mat-error>
                  El estado es requerido
                </mat-error>
              }
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Prioridad</mat-label>
            <input matInput type="number" formControlName="priority" placeholder="Ingrese la prioridad" />
            @if (form.get('priority')?.invalid && form.get('priority')?.touched) {
              <mat-error>
                @if (form.get('priority')?.errors?.['required']) {
                  La prioridad es requerida
                }
                @if (form.get('priority')?.errors?.['min']) {
                  La prioridad debe ser mayor o igual a 0
                }
              </mat-error>
            }
          </mat-form-field>

          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Válido Desde</mat-label>
              <input matInput [matDatepicker]="pickerFrom" formControlName="validFrom" placeholder="Seleccione fecha (opcional)" />
              <mat-datepicker-toggle matIconSuffix [for]="pickerFrom"></mat-datepicker-toggle>
              <mat-datepicker #pickerFrom></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Válido Hasta</mat-label>
              <input matInput [matDatepicker]="pickerUntil" formControlName="validUntil" placeholder="Seleccione fecha (opcional)" />
              <mat-datepicker-toggle matIconSuffix [for]="pickerUntil"></mat-datepicker-toggle>
              <mat-datepicker #pickerUntil></mat-datepicker>
            </mat-form-field>
          </div>

          @if (form.errors?.['dateRangeInvalid'] && form.touched) {
            <div class="error-message">
              La fecha "Válido Hasta" debe ser posterior a "Válido Desde"
            </div>
          }

          <!-- Product Management Section -->
          <div class="products-section">
            <div class="section-header">
              <h3>
                Productos
                @if (productCount > 0) {
                  <mat-icon [matBadge]="productCount" matBadgeColor="accent" matBadgeSize="small">shopping_cart</mat-icon>
                }
              </h3>
              <button mat-raised-button color="accent" type="button" (click)="openProductDialog()">
                <mat-icon>add</mat-icon>
                Agregar Productos
              </button>
            </div>

            @if (productCount === 0) {
              <div class="no-products">
                <mat-icon>info</mat-icon>
                <p>No hay productos agregados. Haga clic en "Agregar Productos" para comenzar.</p>
              </div>
            } @else {
              <div class="table-container">
                <table mat-table [dataSource]="productItems()" class="products-table">

                  <!-- Columna Checkbox -->
                  <ng-container matColumnDef="select">
                    <th mat-header-cell *matHeaderCellDef>Seleccionar</th>
                    <td mat-cell *matCellDef="let item">
                      <mat-checkbox
                        [checked]="item.isSelected"
                        (change)="toggleProductSelection(item.productId)">
                      </mat-checkbox>
                    </td>
                  </ng-container>

                  <!-- Columna Nombre -->
                  <ng-container matColumnDef="name">
                    <th mat-header-cell *matHeaderCellDef>Producto</th>
                    <td mat-cell *matCellDef="let item">{{ item.productName }}</td>
                  </ng-container>

                  <!-- Columna Precio Actual (solo en modo edición) -->
                  <ng-container matColumnDef="currentPrice">
                    <th mat-header-cell *matHeaderCellDef>Precio Actual</th>
                    <td mat-cell *matCellDef="let item">
                      {{ item.currentPrice ? (item.currentPrice | currency) : '-' }}
                    </td>
                  </ng-container>

                  <!-- Columna Nuevo Precio (editable en ambos modos) -->
                  <ng-container matColumnDef="newPrice">
                    <th mat-header-cell *matHeaderCellDef>
                      @if (mode() === 'create') {
                        Precio
                      } @else {
                        Nuevo Precio
                      }
                    </th>
                    <td mat-cell *matCellDef="let item">
                      <mat-form-field appearance="outline" class="price-input">
                        <input matInput type="number" step="0.01" min="0"
                               [value]="item.price"
                               (blur)="onPriceChange(item.productId, +$any($event.target).value)"
                               (keydown.enter)="$any($event.target).blur(); $event.preventDefault()"
                               placeholder="0.00" />
                      </mat-form-field>
                    </td>
                  </ng-container>

                  <!-- Columna Variación (solo en modo edición) -->
                  <ng-container matColumnDef="variation">
                    <th mat-header-cell *matHeaderCellDef>Variación</th>
                    <td mat-cell *matCellDef="let item">
                    <span [class]="getVariationClass(item.currentPrice, item.price)">
                      {{ calculateVariation(item.currentPrice, item.price) }}
                    </span>
                    </td>
                  </ng-container>

                  <!-- Columna Acciones -->
                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Acciones</th>
                    <td mat-cell *matCellDef="let item">
                      <button
                        mat-icon-button
                        color="warn"
                        type="button"
                        (click)="removeProduct(item.productId)"
                        aria-label="Eliminar producto">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                </table>
              </div>

              <div class="products-info">
                <p>Total de productos: <strong>{{ productCount }}</strong></p>
              </div>
            }
          </div>

          <div class="actions">
            <button mat-button type="button" (click)="cancel()">
              Cancelar
            </button>
            <button mat-raised-button color="primary" type="submit" [disabled]="loading()">
              {{ submitButtonText }}
            </button>
          </div>
        </form>
      }
    </mat-card-content>
  </mat-card>
</div>

